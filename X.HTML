<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeerCord | P2P Video Chat</title>
   
    <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>

    <style>
        /* * ==========================================================================
         * CSS: Discord-Inspired Dark Theme
         * ==========================================================================
         */
        :root {
            /* Discord Color Palette */
            --bg-tertiary: #202225;
            --bg-secondary: #2f3136;
            --bg-primary: #36393f;
            --channel-textarea: #40444b;
            --text-normal: #dcddde;
            --text-muted: #72767d;
            --header-primary: #ffffff;
            --interactive-normal: #b9bbbe;
            --interactive-hover: #dcddde;
            --brand-experiment: #5865f2; /* Blurple */
            --brand-hover: #4752c4;
            --danger: #ed4245;
            --success: #3ba55c;
            --warning: #faa61a;
           
            --font-primary: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--bg-tertiary) var(--bg-secondary);
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º (Webkit) */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background-color: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background-color: var(--bg-tertiary); border-radius: 4px; }

        body {
            background-color: var(--bg-primary);
            color: var(--text-normal);
            font-family: var(--font-primary);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« (ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢) --- */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-box {
            background-color: var(--bg-secondary);
            padding: 32px;
            border-radius: 5px;
            width: 100%;
            max-width: 480px;
            box-shadow: 0 2px 10px 0 rgba(0,0,0,0.2);
            text-align: center;
        }
        .login-box h2 { margin-bottom: 8px; color: var(--header-primary); }
        .login-box p { color: var(--text-muted); margin-bottom: 24px; font-size: 14px; }

        .form-group { text-align: left; margin-bottom: 20px; }
        .form-label {
            display: block;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .form-input {
            width: 100%;
            padding: 10px;
            background-color: var(--bg-tertiary);
            border: 1px solid rgba(0,0,0,0.3);
            border-radius: 3px;
            color: var(--text-normal);
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-input:focus { border-color: var(--brand-experiment); }

        .btn-brand {
            width: 100%;
            background-color: var(--brand-experiment);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 3px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-brand:hover { background-color: var(--brand-hover); }
        .btn-brand:disabled { background-color: var(--text-muted); cursor: not-allowed; }

        /* --- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        #app-container {
            display: none; /* JSã§flexã«å¤‰æ›´ */
            flex: 1;
            height: 100%;
            overflow: hidden;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            width: 240px;
            background-color: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .sidebar-header {
            height: 48px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--bg-tertiary);
            box-shadow: 0 1px 0 rgba(4,4,5,0.2),0 1.5px 0 rgba(6,6,7,0.05),0 2px 0 rgba(4,4,5,0.05);
            font-weight: 600;
            color: var(--header-primary);
        }

        /* å‚åŠ è€…ãƒªã‚¹ãƒˆ */
        .user-list {
            padding: 8px;
            overflow-y: auto;
            flex: 0 0 30%; /* é«˜ã•ã®30% */
            border-bottom: 1px solid var(--bg-tertiary);
        }
        .list-header {
            padding: 8px 8px 4px 8px;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .user-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            color: var(--interactive-normal);
        }
        .user-item:hover { background-color: rgba(79,84,92,0.16); color: var(--interactive-hover); }
        .avatar {
            width: 32px; height: 32px;
            border-radius: 50%;
            background-color: var(--brand-experiment);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
            color: white;
            font-size: 14px;
            position: relative;
        }
        .status-indicator {
            position: absolute;
            bottom: -2px; right: -2px;
            width: 10px; height: 10px;
            border-radius: 50%;
            background-color: var(--success);
            border: 2px solid var(--bg-secondary);
        }

        /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-primary);
            min-height: 0;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }
        .message {
            margin-bottom: 16px;
            word-wrap: break-word;
        }
        .msg-header {
            display: flex;
            align-items: baseline;
            margin-bottom: 4px;
        }
        .msg-username { font-weight: 500; color: var(--header-primary); margin-right: 8px; cursor: pointer; }
        .msg-username:hover { text-decoration: underline; }
        .msg-time { font-size: 0.75rem; color: var(--text-muted); }
        .msg-content { font-size: 0.95rem; color: var(--text-normal); line-height: 1.4; white-space: pre-wrap; }

        .chat-input-area {
            padding: 0 16px 20px 16px;
        }
        .chat-input-wrapper {
            background-color: var(--channel-textarea);
            border-radius: 8px;
            padding: 10px;
        }
        .chat-input {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-normal);
            font-size: 1rem;
            outline: none;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ (ãƒ“ãƒ‡ã‚ª) */
        .stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: var(--bg-primary);
        }

        /* ãƒ“ãƒ‡ã‚ªã‚°ãƒªãƒƒãƒ‰ */
        .video-grid {
            flex: 1;
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            align-content: center;
            overflow-y: auto;
        }
        .video-card {
            position: relative;
            background-color: black;
            border-radius: 8px;
            aspect-ratio: 16/9;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .video-card video {
            width: 100%; height: 100%;
            object-fit: cover; /* æ ã«åˆã‚ã›ã¦ãƒˆãƒªãƒŸãƒ³ã‚° */
        }
        .video-label {
            position: absolute;
            bottom: 8px; left: 8px;
            background-color: rgba(0,0,0,0.6);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: white;
            font-weight: 600;
            z-index: 10;
        }

        /* è‡ªåˆ†ã®ãƒ“ãƒ‡ã‚ª (PinPé¢¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤) */
        .my-video-overlay {
            position: absolute;
            bottom: 90px;
            right: 20px;
            width: 200px;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 8px;
            border: 2px solid var(--bg-secondary);
            overflow: hidden;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            z-index: 100;
            transition: width 0.3s;
        }
        .my-video-overlay:hover { width: 240px; }
        .my-video-overlay video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); /* é¡åƒ */ }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        .controls {
            height: 80px;
            background-color: #292b2f; /* å°‘ã—æš—ã‚ */
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            flex-shrink: 0;
        }
        .ctrl-btn {
            width: 56px; height: 56px;
            border-radius: 50%;
            border: none;
            background-color: var(--bg-primary);
            color: var(--text-normal);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .ctrl-btn:hover { background-color: var(--bg-tertiary); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .ctrl-btn.active { background-color: var(--header-primary); color: var(--bg-secondary); }
        .ctrl-btn.danger { background-color: var(--danger); color: white; }
        .ctrl-btn.danger:hover { background-color: #a1282a; }

        /* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ (ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³) */
        .reaction-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: calc(100% - 80px);
            pointer-events: none;
            overflow: hidden;
            z-index: 50;
        }
        .emoji-float {
            position: absolute;
            font-size: 3rem;
            animation: floatUp 3s ease-in forwards;
            opacity: 0;
        }
        @keyframes floatUp {
            0% { transform: translateY(100%) scale(0.5); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(-20vh) scale(1.5); opacity: 0; }
        }

        /* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ç¾¤ */
        .reaction-bar {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            border-radius: 24px;
            padding: 8px 16px;
            display: flex;
            gap: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: auto;
        }
        .stage:hover .reaction-bar { opacity: 1; }
        .emoji-btn {
            background: none; border: none; font-size: 24px; cursor: pointer;
            transition: transform 0.1s;
        }
        .emoji-btn:hover { transform: scale(1.3); }

        /* ãƒ¢ãƒã‚¤ãƒ«ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 0; top: 0; bottom: 0;
                z-index: 200;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            .sidebar.open { transform: translateX(0); }
           
            /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ */
            .menu-toggle {
                position: absolute; top: 10px; left: 10px; z-index: 201;
                background: rgba(0,0,0,0.5); color: white; border: none; padding: 8px; border-radius: 4px;
                display: block !important;
            }
            .my-video-overlay {
                width: 100px; bottom: 90px; right: 10px;
            }
        }
        .menu-toggle { display: none; }
    </style>
</head>
<body>

    <div id="modal-overlay">
        <div class="login-box">
            <h2>WebRTC PeerCord</h2>
            <p>ã‚µãƒ¼ãƒãƒ¼ä¸è¦ã®P2Pãƒãƒ£ãƒƒãƒˆ</p>
           
            <div class="form-group">
                <label class="form-label">Room ID (4-8 AlphaNumeric)</label>
                <input type="text" id="room-id" class="form-input" placeholder="e.g. room01" maxlength="8">
            </div>
           
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" id="username" class="form-input" placeholder="Your Name" maxlength="12">
            </div>

            <button id="join-btn" class="btn-brand">ãƒ«ãƒ¼ãƒ ã«å‚åŠ  / ä½œæˆ</button>
           
            <div style="margin-top: 15px; font-size: 12px; color: #ed4245; text-align: left;">
                â€» ã‚«ãƒ¡ãƒ©ã¨ãƒã‚¤ã‚¯ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚<br>
                â€» å­¦æ ¡/ç¤¾å†…LANç­‰ã§UDPãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹å ´åˆã€æ¥ç¶šã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ (TURNã‚µãƒ¼ãƒãƒ¼æœªè¨­å®šã®ãŸã‚)ã€‚
            </div>
        </div>
    </div>

    <div id="app-container">
       
        <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span style="color:var(--text-muted); margin-right:4px;">#</span>
                <span id="display-room-id">general</span>
            </div>

            <div class="list-header">ONLINE â€” <span id="user-count">0</span></div>
            <div class="user-list" id="user-list">
                </div>

            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div style="text-align:center; color:var(--text-muted); margin-top:20px;">
                        ãƒ«ãƒ¼ãƒ ã¸ã‚ˆã†ã“ãï¼<br>ã“ã“ã¯P2Pæš—å·åŒ–ãƒãƒ£ãƒƒãƒˆã§ã™ã€‚
                    </div>
                </div>
                <div class="chat-input-area">
                    <div class="chat-input-wrapper">
                        <input type="text" id="chat-input" class="chat-input" placeholder="Message to room" autocomplete="off">
                    </div>
                </div>
            </div>
        </div>

        <div class="stage">
            <div class="video-grid" id="video-grid"></div>

            <div class="my-video-overlay">
                <video id="my-video" autoplay muted playsinline></video>
                <div class="video-label">Me</div>
            </div>

            <div class="reaction-overlay" id="reaction-layer"></div>

            <div class="reaction-bar">
                <button class="emoji-btn" onclick="sendReaction('ğŸ‘')">ğŸ‘</button>
                <button class="emoji-btn" onclick="sendReaction('â¤ï¸')">â¤ï¸</button>
                <button class="emoji-btn" onclick="sendReaction('ğŸ˜‚')">ğŸ˜‚</button>
                <button class="emoji-btn" onclick="sendReaction('ğŸ˜®')">ğŸ˜®</button>
                <button class="emoji-btn" onclick="sendReaction('ğŸ‰')">ğŸ‰</button>
            </div>

            <div class="controls">
                <button class="ctrl-btn" id="btn-mic" onclick="toggleMic()" title="Mute/Unmute">ğŸ¤</button>
                <button class="ctrl-btn" id="btn-cam" onclick="toggleCam()" title="Camera On/Off">ğŸ“·</button>
                <button class="ctrl-btn" id="btn-screen" onclick="toggleScreen()" title="Share Screen">ğŸ–¥ï¸</button>
                <button class="ctrl-btn danger" onclick="leaveRoom()" title="Disconnect">ğŸšª</button>
            </div>
        </div>
    </div>

    <script>
        // --- è¨­å®šå®šæ•° ---
        const PEER_CONFIG = {
            host: '0.peerjs.com',
            port: 443,
            path: '/',
            secure: true,
            debug: 1 // ã‚¨ãƒ©ãƒ¼èª¿æŸ»ç”¨
        };
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åç”Ÿæˆç”¨ã®è‰²
        const USER_COLORS = ['#5865f2', '#faa61a', '#3ba55c', '#ed4245', '#eb459e'];

        // --- çŠ¶æ…‹ç®¡ç†å¤‰æ•° ---
        let peer = null;
        let myPeerId = null;
        let myStream = null;
        let myVideoTrack = null;  // ã‚«ãƒ¡ãƒ©æ˜ åƒãƒˆãƒ©ãƒƒã‚¯ä¿æŒç”¨
        let myAudioTrack = null;  // ãƒã‚¤ã‚¯éŸ³å£°ãƒˆãƒ©ãƒƒã‚¯ä¿æŒç”¨
        let isScreenSharing = false;
       
        let roomId = "";
        let username = "";
       
        // ãƒ¡ãƒƒã‚·ãƒ¥æ¥ç¶šç®¡ç†
        // peers: ãƒ‡ãƒ¼ã‚¿æ¥ç¶š (DataConnection) ã®ãƒãƒƒãƒ—
        // calls: ãƒ¡ãƒ‡ã‚£ã‚¢æ¥ç¶š (MediaConnection) ã®ãƒãƒƒãƒ—
        const peers = {};
        const calls = {};
        const userMap = {}; // peerId -> { name, color }

        // --- DOMè¦ç´  ---
        const ui = {
            overlay: document.getElementById('modal-overlay'),
            app: document.getElementById('app-container'),
            joinBtn: document.getElementById('join-btn'),
            roomIdInput: document.getElementById('room-id'),
            usernameInput: document.getElementById('username'),
            myVideo: document.getElementById('my-video'),
            videoGrid: document.getElementById('video-grid'),
            chatMsgs: document.getElementById('chat-messages'),
            chatInput: document.getElementById('chat-input'),
            userList: document.getElementById('user-list'),
            userCount: document.getElementById('user-count'),
            displayRoom: document.getElementById('display-room-id'),
            btnMic: document.getElementById('btn-mic'),
            btnCam: document.getElementById('btn-cam'),
            btnScreen: document.getElementById('btn-screen')
        };

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
        ui.joinBtn.addEventListener('click', startApp);
        ui.chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });

        /*
         * 1. ã‚¢ãƒ—ãƒªé–‹å§‹å‡¦ç†
         */
        async function startApp() {
            const rId = ui.roomIdInput.value.trim();
            const uName = ui.usernameInput.value.trim();

            // å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!rId.match(/^[a-zA-Z0-9]{4,8}$/)) {
                alert("ãƒ«ãƒ¼ãƒ IDã¯4ã€œ8æ–‡å­—ã®è‹±æ•°å­—ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™ã€‚");
                return;
            }
            if (!uName) {
                alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            roomId = rId;
            username = uName;
           
            ui.joinBtn.disabled = true;
            ui.joinBtn.textContent = "åˆæœŸåŒ–ä¸­...";

            try {
                // 1. ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾— (ã‚«ãƒ¡ãƒ©ãƒ»ãƒã‚¤ã‚¯)
                // note: å­¦æ ¡ç’°å¢ƒãªã©ã§ã¯ã“ã“ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚try-catchå¿…é ˆ
                myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
               
                // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’è‡ªåˆ†ã®ãƒ“ãƒ‡ã‚ªè¦ç´ ã«ã‚»ãƒƒãƒˆ
                ui.myVideo.srcObject = myStream;
                myVideoTrack = myStream.getVideoTracks()[0];
                myAudioTrack = myStream.getAudioTracks()[0];

                // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã®åˆæœŸåŒ–
                setControlState('mic', true);
                setControlState('cam', true);

                // 2. PeerJSã®åˆæœŸåŒ–ã¨æ¥ç¶šé–‹å§‹
                initPeer();

            } catch (err) {
                console.error("Media Error:", err);
                alert("ã‚«ãƒ¡ãƒ©ã¾ãŸã¯ãƒã‚¤ã‚¯ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨©é™è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nError: " + err.name);
                ui.joinBtn.disabled = false;
                ui.joinBtn.textContent = "å†è©¦è¡Œ";
            }
        }

        /*
         * 2. PeerJS åˆæœŸåŒ–ã¨ãƒ«ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
         * * æˆ¦ç•¥:
         * PeerJS Cloudã«ã¯ã€Œãƒ«ãƒ¼ãƒ æ©Ÿèƒ½ã€ãŒãªã„ãŸã‚ã€IDç”Ÿæˆãƒ«ãƒ¼ãƒ«ã§ç–‘ä¼¼çš„ã«ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹ã€‚
         * Host ID: `pcord-room-[ROOM_ID]`
         * * æ‰‹é †:
         * 1. è‡ªåˆ†ãŒ Host ID ã®å–å¾—ã‚’è©¦ã¿ã‚‹ã€‚
         * 2. æˆåŠŸ -> è‡ªåˆ†ã¯ãƒ›ã‚¹ãƒˆ (æœ€åˆã®å‚åŠ è€…)ã€‚å¾…æ©ŸçŠ¶æ…‹ã¸ã€‚
         * 3. å¤±æ•— (unavailable-id) -> ãƒ›ã‚¹ãƒˆã¯æ—¢ã«ã„ã‚‹ã€‚
         * -> ãƒ©ãƒ³ãƒ€ãƒ IDã§Peerã‚’ä½œæˆã—ã€Host IDã¸æ¥ç¶šã—ã«ã„ãã€‚
         */
        function initPeer() {
            const hostPeerId = `pcord-room-${roomId}`;
           
            // ã¾ãšãƒ›ã‚¹ãƒˆã¨ã—ã¦æ¥ç¶šã‚’è©¦ã¿ã‚‹
            const tempPeer = new Peer(hostPeerId, PEER_CONFIG);

            tempPeer.on('open', (id) => {
                // ãƒ›ã‚¹ãƒˆIDå–å¾—æˆåŠŸ -> è‡ªåˆ†ãŒãƒ›ã‚¹ãƒˆ
                console.log("Role: HOST");
                setupPeer(tempPeer, true);
            });

            tempPeer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    // ãƒ›ã‚¹ãƒˆIDä½¿ç”¨æ¸ˆã¿ -> ã‚²ã‚¹ãƒˆã¨ã—ã¦å‚åŠ 
                    console.log("Role: GUEST (Connecting to host...)");
                    // ã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸtempPeerã¯ç ´æ£„
                    tempPeer.destroy();
                   
                    // æ–°ã—ã„ID(ãƒ©ãƒ³ãƒ€ãƒ )ã§ä½œæˆ
                    const guestPeer = new Peer(PEER_CONFIG);
                    guestPeer.on('open', (id) => {
                        setupPeer(guestPeer, false, hostPeerId);
                    });
                    guestPeer.on('error', (e) => handlePeerError(e));

                } else {
                    handlePeerError(err);
                }
            });
        }

        // å…±é€šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©
        function handlePeerError(err) {
            console.error(err);
            if (err.type === 'peer-unavailable') {
                // æ¥ç¶šã—ã‚ˆã†ã¨ã—ãŸç›¸æ‰‹ãŒã„ãªã„
            } else if (err.type === 'network' || err.type === 'disconnected') {
                alert("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰åˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚å†æ¥ç¶šã‚’è©¦ã¿ã¦ã„ã¾ã™...");
                peer.reconnect();
            } else {
                // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
                console.log("Peer Error: " + err.type);
            }
        }

        /*
         * 3. Peerã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ç™»éŒ²)
         */
        function setupPeer(p, isHost, targetHostId = null) {
            peer = p;
            myPeerId = peer.id;

            // UIåˆ‡ã‚Šæ›¿ãˆ
            ui.overlay.style.display = 'none';
            ui.app.style.display = 'flex';
            ui.displayRoom.textContent = roomId;
           
            // è‡ªåˆ†ã®æƒ…å ±ã‚’ãƒãƒƒãƒ—ã«è¿½åŠ 
            userMap[myPeerId] = { name: username + " (Me)", color: getRandomColor() };
            updateUserList();

            // --- æ¥ç¶šã‚¤ãƒ™ãƒ³ãƒˆ (èª°ã‹ãŒæ¥ç¶šã—ã¦ããŸ) ---
            peer.on('connection', (conn) => {
                handleDataConnection(conn);
            });

            // --- ç€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ (èª°ã‹ãŒé›»è©±ã—ã¦ããŸ) ---
            peer.on('call', (call) => {
                call.answer(myStream); // è‡ªåˆ†ã®æ˜ åƒã‚’è¿”ã™
                handleMediaCall(call);
            });

            // ã‚²ã‚¹ãƒˆã®å ´åˆã€ãƒ›ã‚¹ãƒˆã«æ¥ç¶šã—ã«è¡Œã
            if (!isHost && targetHostId) {
                connectToPeer(targetHostId);
            }
        }

        /*
         * 4. ãƒ‡ãƒ¼ã‚¿æ¥ç¶š (DataConnection) ã®å‡¦ç†
         * ãƒãƒ£ãƒƒãƒˆã€åå‰äº¤æ›ã€ãƒ”ã‚¢ãƒªã‚¹ãƒˆå…±æœ‰ã«ä½¿ç”¨
         */
        function connectToPeer(targetId) {
            if (targetId === myPeerId) return;
            if (peers[targetId]) return; // æ¥ç¶šæ¸ˆã¿

            console.log("Connecting to:", targetId);
            const conn = peer.connect(targetId, { reliable: true });
            handleDataConnection(conn);

            // ãƒ¡ãƒ‡ã‚£ã‚¢ã‚³ãƒ¼ãƒ«ã‚‚åŒæ™‚ã«è¡Œã†
            const call = peer.call(targetId, myStream);
            handleMediaCall(call);
        }

        function handleDataConnection(conn) {
            conn.on('open', () => {
                peers[conn.peer] = conn;
               
                // æ¥ç¶šç¢ºç«‹ç›´å¾Œã€è‡ªåˆ†ã®æƒ…å ±ã‚’é€ä¿¡
                sendData(conn, 'HELLO', { name: username });

                // ã‚‚ã—è‡ªåˆ†ãŒãƒ›ã‚¹ãƒˆãªã‚‰ã€ç¾åœ¨ã®å…¨ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’æ–°å…¥ã‚Šã«é€ã‚‹
                // (ã“ã‚Œã«ã‚ˆã‚Šæ–°å…¥ã‚Šã¯ä»–ã®å…¨å“¡ã¨ãƒ¡ãƒƒã‚·ãƒ¥æ¥ç¶šã§ãã‚‹)
                if (myPeerId === `pcord-room-${roomId}`) {
                    const allPeers = Object.keys(peers); // ãƒ›ã‚¹ãƒˆã‹ã‚‰è¦‹ãŸå…¨ã‚²ã‚¹ãƒˆ
                    // ãƒ›ã‚¹ãƒˆè‡ªèº«ã®IDã¯å«ã¾ãªã„ã®ã§ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯æ¥ç¶šå…ˆ(conn.peer)ãŒãƒ›ã‚¹ãƒˆã ã¨çŸ¥ã£ã¦ã„ã‚‹å‰æã ãŒ
                    // å¿µã®ãŸã‚ãƒªã‚¹ãƒˆã«è‡ªåˆ†(Host)ã‚‚å«ã‚ã‚‹ã‹ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å‡¦ç†ã™ã‚‹ã‹ã€‚
                    // ã“ã“ã§ã¯ã€Œãƒ›ã‚¹ãƒˆä»¥å¤–ã€ã®ãƒªã‚¹ãƒˆã‚’é€ã£ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåŒå£«ã‚’ã¤ãªã’ã‚‹
                    sendData(conn, 'PEER_LIST', { list: allPeers });
                }
            });

            conn.on('data', (data) => {
                const { type, payload } = data;
               
                switch (type) {
                    case 'HELLO':
                        // ç›¸æ‰‹ã®åå‰æƒ…å ±ã‚’å—ã‘å–ã‚‹
                        userMap[conn.peer] = { name: payload.name, color: getRandomColor() };
                        updateUserList();
                        updateVideoLabel(conn.peer, payload.name);
                        addSystemMessage(`${payload.name} ãŒå…¥å®¤ã—ã¾ã—ãŸ`);
                        break;

                    case 'PEER_LIST':
                        // ãƒ›ã‚¹ãƒˆã‹ã‚‰ä»–ã®å‚åŠ è€…ã®ãƒªã‚¹ãƒˆã‚’å—ã‘å–ã£ãŸ -> ãã‚Œãã‚Œã«æ¥ç¶š
                        payload.list.forEach(pid => {
                            if (pid !== myPeerId && !peers[pid]) {
                                connectToPeer(pid);
                            }
                        });
                        break;

                    case 'CHAT':
                        addChatMessage(userMap[conn.peer]?.name || "Unknown", payload.text, payload.time);
                        break;

                    case 'REACTION':
                        showEmoji(payload.emoji);
                        break;
                }
            });

            conn.on('close', () => removePeer(conn.peer));
            conn.on('error', () => removePeer(conn.peer));
        }

        // ãƒ‡ãƒ¼ã‚¿é€ä¿¡ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function sendData(conn, type, payload) {
            if (conn && conn.open) {
                conn.send({ type, payload });
            }
        }
        function broadcastData(type, payload) {
            Object.values(peers).forEach(conn => sendData(conn, type, payload));
        }

        /*
         * 5. ãƒ¡ãƒ‡ã‚£ã‚¢æ¥ç¶š (MediaConnection) ã®å‡¦ç†
         * æ˜ åƒãƒ»éŸ³å£°ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ åˆ¶å¾¡
         */
        function handleMediaCall(call) {
            calls[call.peer] = call;

            call.on('stream', (remoteStream) => {
                // æ—¢ã«ãƒ“ãƒ‡ã‚ªãŒã‚ã‚Œã°è¿½åŠ ã—ãªã„
                if (document.getElementById(`video-${call.peer}`)) return;
               
                addVideo(call.peer, remoteStream);
            });

            call.on('close', () => removePeer(call.peer));
            call.on('error', () => removePeer(call.peer));
        }

        /*
         * 6. UIæ“ä½œ: ãƒ“ãƒ‡ã‚ªãƒ»ãƒªã‚¹ãƒˆãƒ»ãƒãƒ£ãƒƒãƒˆ
         */
        function addVideo(peerId, stream) {
            const div = document.createElement('div');
            div.className = 'video-card';
            div.id = `container-${peerId}`;

            const video = document.createElement('video');
            video.id = `video-${peerId}`;
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;

            const label = document.createElement('div');
            label.className = 'video-label';
            label.id = `label-${peerId}`;
            label.textContent = userMap[peerId]?.name || "Connecting...";

            div.appendChild(video);
            div.appendChild(label);
            ui.videoGrid.appendChild(div);
        }

        function removePeer(peerId) {
            if (peers[peerId]) {
                addSystemMessage(`${userMap[peerId]?.name || peerId} ãŒé€€å‡ºã—ã¾ã—ãŸ`);
                delete peers[peerId];
            }
            if (calls[peerId]) delete calls[peerId];
            if (userMap[peerId]) delete userMap[peerId];

            const el = document.getElementById(`container-${peerId}`);
            if (el) el.remove();
           
            updateUserList();
        }

        function updateVideoLabel(peerId, name) {
            const el = document.getElementById(`label-${peerId}`);
            if (el) el.textContent = name;
        }

        function updateUserList() {
            ui.userList.innerHTML = '';
            const allIds = [myPeerId, ...Object.keys(peers)];
            ui.userCount.textContent = allIds.length;

            allIds.forEach(id => {
                if (!userMap[id]) return;
                const u = userMap[id];
               
                const item = document.createElement('div');
                item.className = 'user-item';
                item.innerHTML = `
                    <div class="avatar" style="background-color:${u.color}">
                        ${u.name.charAt(0).toUpperCase()}
                        <div class="status-indicator"></div>
                    </div>
                    <span>${u.name}</span>
                `;
                ui.userList.appendChild(item);
            });
        }

        function sendChat() {
            const text = ui.chatInput.value.trim();
            if (!text) return;
           
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            // è‡ªåˆ†ã«è¡¨ç¤º
            addChatMessage(username, text, time);
            // å…¨å“¡ã«é€ä¿¡
            broadcastData('CHAT', { text, time });
           
            ui.chatInput.value = '';
        }

        function addChatMessage(name, text, time) {
            const div = document.createElement('div');
            div.className = 'message';
            // å®‰å…¨ãªHTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            const safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
           
            div.innerHTML = `
                <div class="msg-header">
                    <span class="msg-username">${name}</span>
                    <span class="msg-time">${time}</span>
                </div>
                <div class="msg-content">${safeText}</div>
            `;
            ui.chatMsgs.appendChild(div);
            ui.chatMsgs.scrollTop = ui.chatMsgs.scrollHeight;
        }

        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.style.color = "var(--text-muted)";
            div.style.fontSize = "12px";
            div.style.margin = "8px 0";
            div.textContent = `>>> ${text}`;
            ui.chatMsgs.appendChild(div);
        }

        // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡
        function sendReaction(emoji) {
            showEmoji(emoji);
            broadcastData('REACTION', { emoji });
        }

        function showEmoji(emoji) {
            const el = document.createElement('div');
            el.className = 'emoji-float';
            el.textContent = emoji;
            // ç”»é¢ã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ¨ªä½ç½®ã«å‡ºç¾
            el.style.left = Math.floor(Math.random() * 80 + 10) + '%';
            document.getElementById('reaction-layer').appendChild(el);
           
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«å‰Šé™¤
            setTimeout(() => el.remove(), 3000);
        }

        /*
         * 7. ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½ (ãƒŸãƒ¥ãƒ¼ãƒˆã€ç”»é¢å…±æœ‰ãªã©)
         */
        function toggleMic() {
            if (!myAudioTrack) return;
            const enabled = !myAudioTrack.enabled;
            myAudioTrack.enabled = enabled;
            setControlState('mic', enabled);
        }

        function toggleCam() {
            // ç”»é¢å…±æœ‰ä¸­ã¯ã‚«ãƒ¡ãƒ©æ“ä½œã‚’ç„¡åŠ¹åŒ–ï¼ˆã¾ãŸã¯è­¦å‘Šï¼‰
            if (isScreenSharing) {
                alert("ç”»é¢å…±æœ‰ä¸­ã¯ã‚«ãƒ¡ãƒ©ã‚’æ“ä½œã§ãã¾ã›ã‚“ã€‚å…ˆã«å…±æœ‰ã‚’åœæ­¢ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            if (!myVideoTrack) return;
            const enabled = !myVideoTrack.enabled;
            myVideoTrack.enabled = enabled;
            setControlState('cam', enabled);
        }

        async function toggleScreen() {
            if (isScreenSharing) {
                // --- å…±æœ‰åœæ­¢ ---
                // å…ƒã®ã‚«ãƒ¡ãƒ©ãƒˆãƒ©ãƒƒã‚¯ã«æˆ»ã™
                replaceVideoTrack(myVideoTrack);
                ui.myVideo.srcObject = myStream;
                isScreenSharing = false;
                setControlState('screen', false);
               
                // ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å¾©å¸°
                setControlState('cam', myVideoTrack.enabled);

            } else {
                // --- å…±æœ‰é–‹å§‹ ---
                try {
                    const displayStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const screenTrack = displayStream.getVideoTracks()[0];

                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ–ãƒ©ã‚¦ã‚¶ã®åœæ­¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®å‡¦ç†
                    screenTrack.onended = () => {
                        if (isScreenSharing) toggleScreen();
                    };

                    replaceVideoTrack(screenTrack);
                    ui.myVideo.srcObject = displayStream; // è‡ªåˆ†ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚å¤‰æ›´
                   
                    isScreenSharing = true;
                    setControlState('screen', true);
                   
                } catch (err) {
                    console.error("Screen Share Error:", err);
                }
            }
        }

        // WebRTCã®Senderãƒˆãƒ©ãƒƒã‚¯ã‚’ç½®æ›ã™ã‚‹é«˜åº¦ãªå‡¦ç†
        // å†æ¥ç¶šã™ã‚‹ã“ã¨ãªãã€ç›¸æ‰‹ã«é€ã‚‹æ˜ åƒã‚½ãƒ¼ã‚¹ã ã‘ã‚’ã‚«ãƒ¡ãƒ©<->ç”»é¢å…±æœ‰ã§åˆ‡ã‚Šæ›¿ãˆã‚‹
        function replaceVideoTrack(newTrack) {
            Object.values(calls).forEach(call => {
                const sender = call.peerConnection.getSenders().find(s => s.track.kind === 'video');
                if (sender) {
                    sender.replaceTrack(newTrack);
                }
            });
        }

        function leaveRoom() {
            if (confirm("ãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ")) {
                peer.destroy();
                window.location.reload();
            }
        }

        // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®å¤‰æ›´
        function setControlState(type, isActive) {
            const btn = type === 'mic' ? ui.btnMic :
                        type === 'cam' ? ui.btnCam :
                        type === 'screen' ? ui.btnScreen : null;
           
            if (!btn) return;

            if (type === 'screen') {
                if (isActive) {
                    btn.classList.add('active');
                    btn.style.color = "var(--bg-secondary)";
                } else {
                    btn.classList.remove('active');
                    btn.style.color = "";
                }
                return;
            }

            // Mic & Cam: Active means "ON" (White/Normal), Inactive means "OFF" (Red/Strike)
            if (isActive) {
                btn.classList.add('active'); // ç™½èƒŒæ™¯
                btn.classList.remove('danger');
                if (type === 'mic') btn.textContent = 'ğŸ¤';
                if (type === 'cam') btn.textContent = 'ğŸ“·';
            } else {
                btn.classList.remove('active');
                btn.classList.add('danger'); // èµ¤èƒŒæ™¯
                if (type === 'mic') btn.textContent = 'ğŸ”‡';
                if (type === 'cam') btn.textContent = 'ğŸš«'; // ã‚«ãƒ¡ãƒ©ã‚ªãƒ•ã‚¢ã‚¤ã‚³ãƒ³
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function getRandomColor() {
            return USER_COLORS[Math.floor(Math.random() * USER_COLORS.length)];
        }
    </script>
</body>
</html>